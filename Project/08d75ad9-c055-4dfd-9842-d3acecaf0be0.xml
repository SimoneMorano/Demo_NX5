<StructuredTextModel xmlns="http://schemas.datacontract.org/2004/07/Omron.Cxap.Modules.StructuredText.Core" xmlns:i="http://www.w3.org/2001/XMLSchema-instance"><Text>//FB name: MC_Power1S&#xD;
&#xD;
//Revision: 1.08&#xD;
//Library: OneS_Positioning&#xD;
//Namespace: OMR_CH_PP_Pos&#xD;
//Autor: UN 28.11.16&#xD;
// Changes:&#xD;
// V1.08  During homing, do nothing with MC_Power.  Axis.Details.HomeInProgress is used to signal that homing is in progress&#xD;
&#xD;
// Function: Power the servo motor&#xD;
// Input/Output:&#xD;
//		AxisPar  -&gt; Axis structure of PP_Positioning&#xD;
// Input: &#xD;
//		Enable [BOOL]&#xD;
&#xD;
// Output:&#xD;
//		Busy [BOOL]  &#xD;
//		ErrorID [UINT] failure numbers of PP_Positioning are used.  &#xD;
//		Error [BOOL]  error appeared&#xD;
&#xD;
&#xD;
CASE state OF&#xD;
	0: &#xD;
		IF (Enable AND NOT Axis.Details.HomeInProgress) THEN&#xD;
			Error:= FALSE;&#xD;
			ErrorID := 16#0;&#xD;
&#xD;
				IF ((Axis.StatusWord AND WORD#16#004F) = WORD#2#0100_0000 )   THEN // x1xx_0000 = SwitchOnDisabled&#xD;
					Axis.Target_position:= Axis.Position_actual_value;   //Otherwise it moves immediately if in ModeOfOperation 8 !&#xD;
					dint_AxisPosAndHomeOffset:=Axis.Target_position+Axis.HomeOffset; //V1.07 02.10.2017   add Axis.HomeOffset&#xD;
					Axis.Cmd.Pos := DINT_TO_LREAL(dint_AxisPosAndHomeOffset);	//V1.07 02.10.2017&#xD;
					Axis.Cmd.Vel := 0;&#xD;
					Axis.ControlWord :=  WORD#16#6;&#xD;
					FB_SDO_Write607F.Execute := FALSE;&#xD;
					Axis.ModeOfOperation:= 1;&#xD;
					state:= 10;				&#xD;
					Busy:=TRUE;&#xD;
				ELSIF  ( (Axis.StatusWord AND WORD#16#006F) = WORD#2#0010_0011 ) OR  ( (Axis.StatusWord AND WORD#16#006F) = WORD#2#0010_0001 ) THEN&#xD;
					Axis.Target_position:= Axis.Position_actual_value;   //Otherwise it moves immediately if in ModeOfOperation 8 !&#xD;
					Axis.Cmd.Pos := Axis.Target_position+Axis.HomeOffset;&#xD;
					Axis.ControlWord := Axis.ControlWord  OR WORD#16#F;  //hex F&#xD;
					FB_SDO_Write607F.Execute := FALSE;&#xD;
					Axis.ModeOfOperation:= 1;&#xD;
					state:= 15;&#xD;
					Busy:=TRUE;				&#xD;
				ELSE&#xD;
					IF NOT Axis.DrvStatus.MainPower  THEN&#xD;
						ErrorID := ERR_MAIN_POWER;			//16#0748; 		Switch on was sent when main power  off&#xD;
						Error:= TRUE;&#xD;
						state:= 10000;&#xD;
					END_IF;&#xD;
				END_IF;&#xD;
&#xD;
		END_IF;&#xD;
	10:&#xD;
		IF Enable THEN&#xD;
			IF  ( (Axis.StatusWord AND WORD#16#006F) = WORD#2#0010_0011 ) OR  ( (Axis.StatusWord AND WORD#16#006F) = WORD#2#0010_0001 ) THEN // x01x_00011 = SwitchedOn&#xD;
				Axis.ControlWord := Axis.ControlWord  OR WORD#2#1111;  //hex F&#xD;
				state := 15;&#xD;
			ELSE&#xD;
				;&#xD;
			END_IF;&#xD;
		ELSE&#xD;
				Axis.ControlWord:= Axis.ControlWord AND WORD#2#1111_1111_1111_1101; //xxxx_xxxx_xxxx_xx0x = Disable Voltage command&#xD;
				state := 0;&#xD;
		END_IF;&#xD;
	 15:&#xD;
	 	IF Enable THEN&#xD;
			FB_SDO_Write607F.Execute := TRUE;&#xD;
			IF  ( (Axis.StatusWord AND WORD#16#006F) = WORD#2#0010_0111 )  THEN // x01x_0111 = OperationEnabled&#xD;
				state := 20;&#xD;
			ELSE&#xD;
				IF (Axis.StatusWord AND WORD#16#0270) = WORD#16#0270 THEN&#xD;
					state := 0;&#xD;
				END_IF;&#xD;
			END_IF;&#xD;
		ELSE&#xD;
		  state := 100;&#xD;
		END_IF;&#xD;
		&#xD;
	20:		// Write 607F Maximum Profile Velocity, to reduce PDO communication     Max profile Vel is set to the maximum&#xD;
		IF Enable THEN&#xD;
			IF FB_SDO_Write607F.Done THEN&#xD;
				state := 100;&#xD;
				Status := TRUE;&#xD;
			ELSIF FB_SDO_Write607F.Error THEN&#xD;
				ErrorID := FB_SDO_Write607F.ErrorID;&#xD;
				state  := 10020;&#xD;
			END_IF;&#xD;
		ELSE&#xD;
			state := 100;&#xD;
		END_IF;&#xD;
	100:&#xD;
		Status:= TRUE;&#xD;
		IF NOT Enable THEN&#xD;
			Axis.ControlWord := Axis.ControlWord AND  WORD#2#0111; //xxxx_xxxx_xxxx_x111= Shutdown command	&#xD;
			Axis.Cmd.Vel := 0;&#xD;
			state := 200;&#xD;
			Status := 0;&#xD;
		ELSIF Axis.Details.HomeInProgress THEN&#xD;
			state := 0;		//V1.08  during homing, do nothing with MC_Power&#xD;
		ELSIF (NOT Axis.Status.Ready) OR (Axis.DrvStatus.DrvAlarm) THEN&#xD;
			ErrorID := ERR_SERVO_OFF;			//16#5441   Operation with ServoOff&#xD;
			state := 10100;&#xD;
		END_IF;&#xD;
	&#xD;
	200:   //Switch off (normal)&#xD;
		state := 0;&#xD;
		Busy:=0;&#xD;
		Status :=0;&#xD;
&#xD;
	10000..20000:	//Errorhandling&#xD;
		Error:=TRUE;&#xD;
		Status:=0;&#xD;
		Axis.ControlWord := Axis.ControlWord AND WORD#2#1111_1111_1111_1110 OR WORD#2#0110; //xxxx_xxxx_xxxx_x11x= Shutdown command	&#xD;
		Busy:=0;&#xD;
		state := 0;	&#xD;
END_CASE;&#xD;
&#xD;
&#xD;
FB_SDO_Write607F(NodeAdr:=Axis.Cfg.NodeAddress,SdoObj:=SdoObj607F,TimeOut:=10,WriteDat:=WriteDat2147483647,WriteSize:=4);   //SDO for Maximum Profile Velocity  (just to reduce PDO communication)</Text></StructuredTextModel>